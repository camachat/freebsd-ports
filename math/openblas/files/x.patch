--- Makefile.system.orig	2016-08-31 20:58:42.000000000 -0700
+++ Makefile.system	2017-04-19 15:33:51.450112000 -0700
@@ -222,6 +222,7 @@ MD5SUM = md5 -r
 endif
 
 ifeq ($(OSNAME), FreeBSD)
+EXTRALIB	+= -lm  -Wl,-rpath=/usr/local/lib/gcc5  -L/usr/local/lib/gcc5 -B/usr/local/bin -fstack-protector -Wl,-rpath=/usr/local/lib/gcc5 -L/usr/local/lib/gcc5
 MD5SUM = md5 -r
 endif
 
@@ -274,7 +275,7 @@ endif
 
 # Ensure the correct stack alignment on Win32
 # http://permalink.gmane.org/gmane.comp.lib.openblas.general/97
-ifeq ($(ARCH), x86)
+ifeq ($(ARCH_), x86)
 CCOMMON_OPT += -mincoming-stack-boundary=2
 FCOMMON_OPT += -mincoming-stack-boundary=2
 endif
@@ -315,8 +316,8 @@ CCOMMON_OPT	+= -DQUAD_PRECISION
 NO_EXPRECISION = 1
 endif
 
-ifneq ($(ARCH), x86)
-ifneq ($(ARCH), x86_64)
+ifneq ($(ARCH_), x86)
+ifneq ($(ARCH_), x86_64)
 NO_EXPRECISION = 1
 endif
 endif
@@ -339,7 +340,7 @@ endif
 #  Architecture dependent settings
 #
 
-ifeq ($(ARCH), x86)
+ifeq ($(ARCH_), x86)
 ifndef BINARY
 NO_BINARY_MODE	= 1
 endif
@@ -365,7 +366,7 @@ endif
 endif
 endif
 
-ifeq ($(ARCH), x86_64)
+ifeq ($(ARCH_), x86_64)
 
 ifeq ($(CORE), generic)
 NO_EXPRECISION = 1
@@ -406,7 +407,7 @@ CCOMMON_OPT    += -fopenmp
 endif
 
 ifeq ($(C_COMPILER), CLANG)
-$(error OpenBLAS: Clang didn't support OpenMP yet.)
+
 CCOMMON_OPT    += -fopenmp
 endif
 
@@ -430,12 +431,12 @@ endif
 
 
 ifeq ($(DYNAMIC_ARCH), 1)
-ifeq ($(ARCH), x86)
+ifeq ($(ARCH_), x86)
 DYNAMIC_CORE = KATMAI COPPERMINE NORTHWOOD PRESCOTT BANIAS \
 	       CORE2 PENRYN DUNNINGTON NEHALEM ATHLON OPTERON OPTERON_SSE3 BARCELONA BOBCAT ATOM NANO
 endif
 
-ifeq ($(ARCH), x86_64)
+ifeq ($(ARCH_), x86_64)
 DYNAMIC_CORE = PRESCOTT CORE2 PENRYN DUNNINGTON NEHALEM OPTERON OPTERON_SSE3 BARCELONA BOBCAT ATOM NANO
 ifneq ($(NO_AVX), 1)
 DYNAMIC_CORE += SANDYBRIDGE BULLDOZER PILEDRIVER STEAMROLLER EXCAVATOR
@@ -450,7 +451,7 @@ DYNAMIC_ARCH =
 endif
 endif
 
-ifeq ($(ARCH), ia64)
+ifeq ($(ARCH_), ia64)
 NO_BINARY_MODE	= 1
 BINARY_DEFINED	= 1
 
@@ -462,21 +463,21 @@ endif
 endif
 endif
 
-ifeq ($(ARCH), $(filter $(ARCH),mips64 mips))
+ifeq ($(ARCH_), $(filter $(ARCH),mips64 mips))
 NO_BINARY_MODE	= 1
 endif
 
-ifeq ($(ARCH), alpha)
+ifeq ($(ARCH_), alpha)
 NO_BINARY_MODE	= 1
 BINARY_DEFINED	= 1
 endif
 
-ifeq ($(ARCH), arm)
+ifeq ($(ARCH_), arm)
 NO_BINARY_MODE  = 1
 BINARY_DEFINED  = 1
 endif
 
-ifeq ($(ARCH), arm64)
+ifeq ($(ARCH_), arm64)
 NO_BINARY_MODE  = 1
 BINARY_DEFINED  = 1
 endif
@@ -502,14 +503,14 @@ endif
 
 ifdef NO_BINARY_MODE
 
-ifeq ($(ARCH), $(filter $(ARCH),mips64))
+ifeq ($(ARCH_), $(filter $(ARCH),mips64))
 ifdef BINARY64
 CCOMMON_OPT += -mabi=64
 else
 CCOMMON_OPT += -mabi=n32
 endif
 BINARY_DEFINED = 1
-else ifeq ($(ARCH), $(filter $(ARCH),mips))
+else ifeq ($(ARCH_), $(filter $(ARCH),mips))
 CCOMMON_OPT += -mabi=32
 BINARY_DEFINED = 1
 endif
@@ -607,13 +608,13 @@ ifneq ($(NO_LAPACK), 1)
 EXTRALIB += -lgfortran
 endif
 ifdef NO_BINARY_MODE
-ifeq ($(ARCH), $(filter $(ARCH),mips64))
+ifeq ($(ARCH_), $(filter $(ARCH),mips64))
 ifdef BINARY64
 FCOMMON_OPT += -mabi=64
 else
 FCOMMON_OPT += -mabi=n32
 endif
-else ifeq ($(ARCH), $(filter $(ARCH),mips))
+else ifeq ($(ARCH_), $(filter $(ARCH),mips))
 FCOMMON_OPT += -mabi=32
 endif
 else
@@ -713,7 +714,7 @@ endif
 endif
 endif
 
-ifeq ($(ARCH), $(filter $(ARCH),mips64 mips))
+ifeq ($(ARCH_), $(filter $(ARCH),mips64 mips))
 ifndef BINARY64
 FCOMMON_OPT += -n32
 else
@@ -743,7 +744,7 @@ endif
 
 ifeq ($(C_COMPILER), OPEN64)
 
-ifeq ($(ARCH), $(filter $(ARCH),mips64 mips))
+ifeq ($(ARCH_), $(filter $(ARCH),mips64 mips))
 ifndef BINARY64
 CCOMMON_OPT += -n32
 else
@@ -769,7 +770,7 @@ endif
 
 ifeq ($(C_COMPILER), SUN)
 CCOMMON_OPT  += -w
-ifeq ($(ARCH), x86)
+ifeq ($(ARCH_), x86)
 CCOMMON_OPT  += -m32
 else
 FCOMMON_OPT  += -m64
@@ -778,7 +779,7 @@ endif
 
 ifeq ($(F_COMPILER), SUN)
 CCOMMON_OPT  += -DF_INTERFACE_SUN
-ifeq ($(ARCH), x86)
+ifeq ($(ARCH_), x86)
 FCOMMON_OPT  += -m32
 else
 FCOMMON_OPT  += -m64
@@ -835,7 +836,7 @@ ifeq ($(NO_AVX), 1)
 CCOMMON_OPT	+= -DNO_AVX
 endif
 
-ifeq ($(ARCH), x86)
+ifeq ($(ARCH_), x86)
 CCOMMON_OPT	+= -DNO_AVX
 endif
 
@@ -846,7 +847,7 @@ endif
 ifdef SMP
 CCOMMON_OPT	+= -DSMP_SERVER
 
-ifeq ($(ARCH), mips64)
+ifeq ($(ARCH_), mips64)
 ifneq ($(CORE), LOONGSON3B)
 USE_SIMPLE_THREADED_LEVEL3 = 1
 endif
@@ -902,14 +903,22 @@ SYMBOLSUFFIX =
 endif
 
 ifndef LIBNAMESUFFIX
+ifndef SMP
 LIBPREFIX = lib$(SYMBOLPREFIX)openblas$(SYMBOLSUFFIX)
 else
+LIBPREFIX = lib$(SYMBOLPREFIX)openblasp$(SYMBOLSUFFIX)
+endif
+else
+ifndef SMP
 LIBPREFIX = lib$(SYMBOLPREFIX)openblas$(SYMBOLSUFFIX)_$(LIBNAMESUFFIX)
+else
+LIBPREFIX = lib$(SYMBOLPREFIX)openblasp$(SYMBOLSUFFIX)_$(LIBNAMESUFFIX)
+endif
 endif
 
-KERNELDIR	= $(TOPDIR)/kernel/$(ARCH)
+KERNELDIR	= $(TOPDIR)/kernel/$(ARCH_)
 
-include $(TOPDIR)/Makefile.$(ARCH)
+include $(TOPDIR)/Makefile.$(ARCH_)
 
 CCOMMON_OPT	+= -DASMNAME=$(FU)$(*F) -DASMFNAME=$(FU)$(*F)$(BU) -DNAME=$(*F)$(BU) -DCNAME=$(*F) -DCHAR_NAME=\"$(*F)$(BU)\" -DCHAR_CNAME=\"$(*F)\"
 
@@ -925,8 +934,8 @@ ifneq ($(OSNAME), Linux)
 NO_AFFINITY = 1
 endif
 
-ifneq ($(ARCH), x86_64)
-ifneq ($(ARCH), x86)
+ifneq ($(ARCH_), x86_64)
+ifneq ($(ARCH_), x86)
 ifneq ($(CORE), LOONGSON3B)
 NO_AFFINITY = 1
 endif
@@ -990,11 +999,11 @@ FCOMMON_OPT += -g
 endif
 
 ifndef COMMON_OPT
-COMMON_OPT = -O2
+#COMMON_OPT = -O2
 endif
 
 ifndef FCOMMON_OPT
-FCOMMON_OPT = -O2 -frecursive
+#FCOMMON_OPT = -O2 -frecursive
 endif
 
 
@@ -1043,24 +1052,8 @@ ifndef LIBSUFFIX
 LIBSUFFIX = a
 endif
 
-ifneq ($(DYNAMIC_ARCH), 1)
-ifndef SMP
-LIBNAME		= $(LIBPREFIX)_$(LIBCORE)$(REVISION).$(LIBSUFFIX)
-LIBNAME_P	= $(LIBPREFIX)_$(LIBCORE)$(REVISION)_p.$(LIBSUFFIX)
-else
-LIBNAME		= $(LIBPREFIX)_$(LIBCORE)p$(REVISION).$(LIBSUFFIX)
-LIBNAME_P	= $(LIBPREFIX)_$(LIBCORE)p$(REVISION)_p.$(LIBSUFFIX)
-endif
-else
-ifndef SMP
 LIBNAME		= $(LIBPREFIX)$(REVISION).$(LIBSUFFIX)
 LIBNAME_P	= $(LIBPREFIX)$(REVISION)_p.$(LIBSUFFIX)
-else
-LIBNAME		= $(LIBPREFIX)p$(REVISION).$(LIBSUFFIX)
-LIBNAME_P	= $(LIBPREFIX)p$(REVISION)_p.$(LIBSUFFIX)
-endif
-endif
-
 
 LIBDLLNAME   = $(LIBPREFIX).dll
 LIBSONAME    = $(LIBNAME:.$(LIBSUFFIX)=.so)
@@ -1090,7 +1083,7 @@ LIB_COMPONENTS = CBLAS
 endif
 
 export OSNAME
-export ARCH
+export ARCH_
 export CORE
 export LIBCORE
 export PGCPATH
